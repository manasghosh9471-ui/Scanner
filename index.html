<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warehouse Pro v4.0 (Offline Mode)</title>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #121212; --card: #1E1E1E; --text: #FFFFFF; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 10px; padding-bottom: 90px; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1E1E1E; display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #333; height: 75px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 12px; border: none; background: none; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; text-align: center; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; }
        .btn { border: none; border-radius: 10px; padding: 16px; font-weight: bold; color: white; cursor: pointer; width: 100%; font-size: 14px; margin-top: 10px;}
        .btn-main { background: var(--primary); }
        /* Sync Indicator */
        #syncStatus { background: #333; padding: 5px; border-radius: 20px; font-size: 11px; margin-bottom: 10px; text-align: center; }
        .online { color: var(--success); }
        .offline { color: var(--danger); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        td { padding: 8px; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <div id="syncStatus" class="online">‚óè SYSTEM ONLINE (0 Pending)</div>

    <div id="scanTab" class="tab-content active-tab">
        <div id="reader"></div>
        <div class="card" id="result" style="margin-top:10px;">READY TO SCAN</div>
        <button id="camBtn" class="btn btn-main" onclick="toggleCamera()">üîò START CAMERA</button>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #333; border-radius: 10px; margin-top: 15px;">
            <table><tbody id="scanTableBody"></tbody></table>
        </div>
    </div>

<textarea id="skuInput" style="display:none;">{"1160W0866GPP":"RSP","1160W1582GNN":"BPFN","1160W0743GPP":"IBKP","1160W0743GNN":"IBKN"}</textarea>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const GOOGLE_URL = "YOUR_DEPLOY_URL_HERE";
let html5QrCode, isScanning = false, isProcessing = false;
let skuMapping = JSON.parse(document.getElementById('skuInput').value);

// --- OFFLINE LOGIC ---
// This queue stays saved in the phone's storage even if the browser closes
let queue = JSON.parse(localStorage.getItem('scanQueue')) || [];

function saveQueue() {
    localStorage.setItem('scanQueue', JSON.stringify(queue));
    updateSyncUI();
}

function updateSyncUI() {
    const status = document.getElementById('syncStatus');
    if (navigator.onLine) {
        status.innerHTML = `‚óè SYSTEM ONLINE (${queue.length} Pending Uploads)`;
        status.className = "online";
        if (queue.length > 0) processQueue();
    } else {
        status.innerHTML = `‚óè OFFLINE MODE (Saving to Memory: ${queue.length})`;
        status.className = "offline";
    }
}

async function processQueue() {
    if (!navigator.onLine || queue.length === 0 || isProcessing) return;
    isProcessing = true;
    
    const item = queue[0];
    try {
        await fetch(GOOGLE_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(item) });
        queue.shift(); // Remove from memory after success
        saveQueue();
        isProcessing = false;
        processQueue(); // Process next item
    } catch (e) {
        isProcessing = false;
    }
}

// Check connection status every 5 seconds
setInterval(updateSyncUI, 5000);
window.addEventListener('online', updateSyncUI);
window.addEventListener('offline', updateSyncUI);

async function toggleCamera() {
    if(isScanning) { await html5QrCode.stop(); isScanning = false; return; }
    html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start({facingMode:"environment"}, {fps:20, qrbox:250}, (text) => {
        let p = parseQR(text);
        if(!p) return;

        // Save to Queue instead of immediate send
        queue.push({skuName: p.skuName, batch: p.batch, fullQR: text, destination: "Raw_Scans"});
        saveQueue();
        
        document.getElementById('result').innerHTML = `<h2 style='color:var(--success)'>SAVED: ${p.skuName}</h2>`;
        updateTable(p);
    });
    isScanning = true;
}

function parseQR(val) {
    if(val.length < 30) return null;
    let s=val.substring(3,15), b=val.substring(15,19), d=val.substring(21,25);
    return {skuName:skuMapping[s]||"UNK", batch:`41-${b}-${d}`};
}

function updateTable(p) {
    let row = `<tr><td>${p.skuName}</td><td>${p.batch}</td><td>OK</td></tr>`;
    document.getElementById('scanTableBody').insertAdjacentHTML('afterbegin', row);
}

updateSyncUI();
</script>
</body>
</html>
