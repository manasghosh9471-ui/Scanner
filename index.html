<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zebra WMS Pro - Industrial</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg-dark: #1c1c1e;
            --card-bg: rgba(44, 44, 46, 0.9);
            --text-main: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
        }

        /* DYNAMIC LOGIN BACKGROUND */
        #loginPage {
            height: 100vh; width: 100%;
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            position: relative;
        }

        #loginPage::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
        }

        .login-card {
            position: relative; z-index: 10;
            background: var(--card-bg); padding: 40px;
            border-radius: 20px; backdrop-filter: blur(10px);
            width: 320px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        input {
            width: 100%; padding: 12px; margin: 10px 0;
            background: #3a3a3c; border: none; border-radius: 8px;
            color: white; font-size: 16px; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 12px; margin-top: 15px;
            background: var(--primary); border: none; border-radius: 8px;
            color: white; font-weight: bold; cursor: pointer;
        }

        /* MAIN APP STYLES */
        #mainApp { display: none; height: 100vh; padding: 20px; box-sizing: border-box; }

        .header { display: flex; justify-content: space-between; align-items: center; }

        /* MINI MODE STYLES */
        .mini-active {
            width: 180px !important; height: 50px !important;
            position: fixed !important; bottom: 10px; right: 10px;
            background: rgba(0, 122, 255, 0.9) !important;
            border-radius: 25px !important; z-index: 9999;
            padding: 5px !important; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .mini-active .hide-on-mini { display: none !important; }
        
        #statusDisplay { font-weight: bold; font-size: 14px; text-align: center; }

        /* MINI TOGGLE BUTTON */
        #miniBtn {
            position: fixed; top: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--primary); color: white; border: none;
            font-size: 12px; z-index: 10000; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h1 style="margin-bottom: 5px;">WMS LOGIN</h1>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 25px;">INDUSTRIAL TERMINAL v2.0</p>
            <input type="text" id="opName" placeholder="Operator Name">
            <input type="password" id="opPin" placeholder="Access PIN">
            <button onclick="login()">ENTER SYSTEM</button>
        </div>
    </div>

    <button id="miniBtn" onclick="toggleMiniMode()" style="display:none;">MINI</button>
    
    <div id="mainApp">
        <div class="header hide-on-mini">
            <div>
                <h2 id="displayUser">---</h2>
                <p id="timeDisplay" style="font-size: 12px; opacity: 0.6;"></p>
            </div>
        </div>

        <div id="statusDisplay">READY TO SCAN</div>

        <input type="text" id="scannerCatch" style="position: absolute; opacity: 0;" autofocus>

        <div class="hide-on-mini" style="margin-top: 20px;">
            <div style="background: var(--card-bg); padding: 15px; border-radius: 12px;">
                <h3>Last Dispatch</h3>
                <div id="logContainer" style="font-family: monospace; font-size: 13px;"></div>
            </div>
        </div>
    </div>

    <script>
        // DYNAMIC BACKGROUND IMAGES
        const bgImages = [
            'https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=1200',
            'https://images.unsplash.com/photo-1553413077-190dd305871c?auto=format&fit=crop&q=80&w=1200',
            'https://images.unsplash.com/photo-1601381718415-a05fb0a261f3?auto=format&fit=crop&q=80&w=1200'
        ];
        let currentBg = 0;
        function rotateBg() {
            currentBg = (currentBg + 1) % bgImages.length;
            document.getElementById('loginPage').style.backgroundImage = `url('${bgImages[currentBg]}')`;
        }
        setInterval(rotateBg, 5000);
        rotateBg();

        // LOGIN LOGIC
        function login() {
            const user = document.getElementById('opName').value;
            if(user) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('miniBtn').style.display = 'block';
                document.getElementById('displayUser').innerText = user;
                startClock();
                keepFocus();
            }
        }

        // MINI MODE TOGGLE
        let isMini = false;
        function toggleMiniMode() {
            isMini = !isMini;
            const app = document.getElementById('mainApp');
            const btn = document.getElementById('miniBtn');
            if(isMini) {
                app.classList.add('mini-active');
                btn.innerText = "MAX";
            } else {
                app.classList.remove('mini-active');
                btn.innerText = "MINI";
            }
            keepFocus();
        }

        // BATCH EXTRACTION LOGIC (41-XXXX-XXX)
        function processScan(raw) {
            try {
                // Logic for 41-0468-226 style extraction
                let b4 = raw.substring(15, 19);
                let match = raw.match(/(\d{4})[A-Z]/);
                let ds = match ? match[1] : raw.substring(21, 25);
                
                // Zero-slice rule
                if (ds.startsWith("0")) ds = ds.substring(1);
                
                let finalBatch = "41-" + b4 + "-" + ds;
                submitToSheet(finalBatch, raw);
            } catch(e) {
                document.getElementById('statusDisplay').innerText = "SCAN ERROR";
            }
        }

        // SUBMIT TO GOOGLE SHEET
        function submitToSheet(batch, raw) {
            const user = document.getElementById('opName').value;
            const url = "https://script.google.com/macros/s/AKfycbwJ0eETIDojVltkz2Qn0bGHG8Yw0UySGFRBqpfq_K5VFucV8Hdyo9MNQ1KApcUFSrTDXg/exec";
            
            document.getElementById('statusDisplay').innerText = "UPDATING: " + batch;

            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    batch: batch,
                    qty: -1, // Auto-Dispatch
                    user: user,
                    raw: raw,
                    timestamp: new Date()
                })
            }).then(() => {
                document.getElementById('statusDisplay').innerText = "SUCCESS: " + batch;
                const log = document.getElementById('logContainer');
                log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${batch} -1</div>` + log.innerHTML;
            });
        }

        // ZEBRA SCANNER INPUT LISTENER
        document.getElementById('scannerCatch').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                processScan(this.value);
                this.value = '';
            }
        });

        function keepFocus() {
            setInterval(() => {
                document.getElementById('scannerCatch').focus();
            }, 1000);
        }

        function startClock() {
            setInterval(() => {
                document.getElementById('timeDisplay').innerText = new Date().toLocaleString();
            }, 1000);
        }
    </script>
</body>
</html>
